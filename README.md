# ДЗ 4. Обучение Stable diffusion 1.5 методом Dreambooth

https://huggingface.co/docs/diffusers/training/dreambooth

## Описание

#### Идея Dreambooth

text to image модель генерирует изображения по какому-то распределению, например по запросу **a photo of woman face**,
модель генерирует фотографию рандомной женщины. Мы хотим сгенерировать фотографию конкретной женщины, фотографий которой
не было датасета при обучении модели, но если обучать модель на небольшом наборе, то неизбежно будем терять уже имеющие
знания модели. Dreambooth отчасти решает эту проблему обучая модель в два этапа, на нашем датасете **instance images** и
на регуляризационном датасете **class images** который собирается из генераций модели.

### 1. Собрать датасет от 15 изображений одно персонажа (чем больше и разнообразнее тем лучше будет качество)

### 2. Кропнуть и заресайзить лица, тут можно обрабатывать сразу все https://www.birme.net/

Для лучшего качества и вариативности лучше брать изображения с разным размером кадра от close-up до medium см. Таблица
1, соотношение можно взять 1 к 1.

Если в трэйне будут только крупные лица то при генерации вряд ли получится хороший средний или крупный план.


<p>
<img src="img/train_images_example/2.png" alt="example" width="200" />
<img src="img/train_images_example/8.jpg" alt="example" width="200" />
<img src="img/train_images_example/18.jpg" alt="example" width="200" />
</p>
<p>
<img src="img/train_images_example/13.png" alt="example" width="200" />
<img src="img/train_images_example/16.png" alt="example" width="200" />
<img src="img/train_images_example/20.jpg" alt="example" width="200" />
</p>
Таблица 1. Пример изображений для обучения

### 3. Скачать предобученный чекпоинт SD1.5 с [civitai.com](https://civitai.com/)

Мы будем использовать библиотеку diffusers и их скрипты для обучения. Чтобы генерации получались более красивые, будем
брать предобученные модели с сайта civitai. Формат весов в нем отличается и туда вкладывают только unet поэтому сначала
модель нужно конвертировать в формат diffusers

### 4. Обучить Stable diffusion 1.5.

##### Параметры

**--instance_prompt="a photo of sks woman face"** токен на который мы хотим обучить персонажа

**--class_prompt="a photo of woman face"** промт для регуляризации

Чтобы не было language drift (когда модель уже содержит знания в каком-то из токенов) мы используем токен sks он был
выбран авторами статьи как один и наименее частотных в датасете.

--instance_data_dir=$INSTANCE_DIR

--class_data_dir=$CLASS_DIR

Чтобы модель не забывала уже то, что знает и не переобучилась используется регуляризационный датасет (class images
генерируется автоматически по промту class_prompt), чтобы изображения были более качественные можете самостоятельно
собрать этот набор).

**! В примере из ноутбука я отдельно собрал class images (добавил negative promt и заменил prompt) чтобы размер кадра
больше соответствовал примерам из обучения и картинки были более качественные и разнообразные, а не только крупный план
лица.**

### Пример генераций в 768х1024

<p>
<img src="img/test_images/1.png" alt="example" width="300" />
<img src="img/test_images/2.png" alt="example" width="300" />
</p>

### 5. Обучить LoRA модель

При успехе обучения чекпоинта целиком, обучить LoRA модель. Ссылка на скрипт обучения и функцию загрузки весов в
пайплайн есть в ноутбуке DreamBooth_Stable_Diffusion.ipynb.

Провести 3 эксперимента по подбору размера LoRa (параметр --rank) Смотрим как размер модели влияет на количество
итераций и итоговое качество. В readme добавить варианты генерации по каждой из моделей.

### 6. Сравнить лучший чекпоинт Unet и Lora

Один лучший чекпоинт обучения Unet и Одна лучшая LoRA модель

### 7. ControlNet

Генерация любого варианта Controlnet из ноутбука, для обученных Unet и Lora

## Задание

- Собрать датасет и обучить Unet - 10 баллов
- Обучить Lora модель и сравнить с Unet 15 баллов
- Добавить в pipeline ControlNet - 5 баллов

### Как правильно сравнивать модели !

Брать одинаковые промты, обязательно фиксировать seed и batch чтобы было явно видно как влияет количество параметров.
Для теста брать 5 промтов!

Собираем набор промтов с разным окружением (пустыне, городе, пляже, луне и т.д, что угодно) чтобы было видно, что модель
не переобучилась и в состоянии генерировать разнообразные сэмплы.

## Результат

### [Ссылка на Каггл](https://www.kaggle.com/code/anastasiiasemina1/dreambooth)

Некоторые фото для обучения:

| ![5_.jpg](img%2Ftest_images%2F5_.jpg) | ![2_.jpg](img%2Ftest_images%2F2_.jpg) | ![1_.jpg](img%2Ftest_images%2F1_.jpg) | ![3_.jpg](img%2Ftest_images%2F3_.jpg) | ![4_.jpg](img%2Ftest_images%2F4_.jpg) |
|---------------------------------------|---------------------------------------|---------------------------------------|---------------------------------------|---------------------------------------|

Генерация без sks токена:

| ![forest.jpg](img%2Fbase_model%2Fforest.jpg) | ![kitchen.jpg](img%2Fbase_model%2Fkitchen.jpg) | ![street.jpg](img%2Fbase_model%2Fstreet.jpg) | ![snow.jpg](img%2Fbase_model%2Fsnow.jpg) | ![sea.jpg](img%2Fbase_model%2Fsea.jpg) |
|----------------------------------------------|------------------------------------------------|----------------------------------------------|------------------------------------------|----------------------------------------|

Дообученая Unet(learning_rate=2e-6), промпты с sks токеном:

| ![forest.jpg](img%2Funet%2Fforest.jpg) | ![kitchen.jpg](img%2Funet%2Fkitchen.jpg) | ![street.jpg](img%2Funet%2Fstreet.jpg) | ![snow.jpg](img%2Funet%2Fsnow.jpg) | ![sea.jpg](img%2Funet%2Fsea.jpg) |
|----------------------------------------|------------------------------------------|----------------------------------------|------------------------------------|----------------------------------|

Lora (learning_rate=2e-4, rank=8):

| ![forest.jpg](img%2Flora_rank8%2Fforest.jpg) | ![kitchen.jpg](img%2Flora_rank8%2Fkitchen.jpg) | ![street.jpg](img%2Flora_rank8%2Fstreet.jpg) | ![snow.jpg](img%2Flora_rank8%2Fsnow.jpg) | ![sea.jpg](img%2Flora_rank8%2Fsea.jpg) |
|----------------------------------------------|------------------------------------------------|----------------------------------------------|------------------------------------------|----------------------------------------|

Lora (learning_rate=2e-3, rank=16):

| ![forest.jpg](img%2Flora_rank16%2Fforest.jpg) | ![kitchen.jpg](img%2Flora_rank16%2Fkitchen.jpg) | ![street.jpg](img%2Flora_rank16%2Fstreet.jpg) | ![snow.jpg](img%2Flora_rank16%2Fsnow.jpg) | ![sea.jpg](img%2Flora_rank16%2Fsea.jpg) |
|-----------------------------------------------|-------------------------------------------------|-----------------------------------------------|-------------------------------------------|-----------------------------------------|

Lora (learning_rate=2e-5, rank=4):

| ![forest.jpg](img%2Flora_rank4%2Fforest.jpg) | ![kitchen.jpg](img%2Flora_rank4%2Fkitchen.jpg) | ![street.jpg](img%2Flora_rank4%2Fstreet.jpg) | ![snow.jpg](img%2Flora_rank4%2Fsnow.jpg) | ![sea.jpg](img%2Flora_rank4%2Fsea.jpg) |
|----------------------------------------------|------------------------------------------------|----------------------------------------------|------------------------------------------|----------------------------------------|

### Выводы

Просто Unet генерирует не идеально, но черты лица перенимает. LORA лучше отработала на rank 4 и 8, на 4 результат более
качественный, но на меня не похож, на 8 качество сильно упало, но схожесть есть. При увеличении rank и lr генерация совсем испортилась.